<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Counter é«˜çº§æµ‹è¯•ï¼ˆIP/ç™½åå•/ç»Ÿè®¡ï¼‰</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto; background:#0b1220; color:#e5e7eb; padding:24px; }
    .wrap { max-width: 900px; margin: 0 auto; display:grid; gap:16px; }
    .card { background:#050b17; border:1px solid #1f2a44; border-radius:14px; padding:18px; }
    h1 { margin:0 0 10px; font-size:20px; }
    .row { display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    label { font-size:13px; color:#93a4c7; }
    input, select { background:#071027; color:#e5e7eb; border:1px solid #24314f; border-radius:10px; padding:10px 12px; outline:none; }
    input { min-width: 280px; }
    button { background:#38bdf8; border:none; border-radius:10px; padding:10px 12px; cursor:pointer; color:#04101d; font-weight:600; }
    button:hover { filter: brightness(1.05); }
    .k { color:#93a4c7; }
    .v { color:#38bdf8; font-weight:700; }
    pre { background:#040a14; border:1px solid #1f2a44; border-radius:12px; padding:12px; overflow:auto; min-height: 120px; }
    .ok { color:#4ade80; }
    .err { color:#fb7185; }
    .small { font-size:12px; color:#93a4c7; }
    .grid2 { display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 860px) { .grid2 { grid-template-columns: 1fr; } }
  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <h1>ğŸ§ª Counter é«˜çº§æµ‹è¯•ï¼ˆIP / ç™½åå• / includeIpsï¼‰</h1>

    <div class="row" style="margin-top:10px;">
      <label>ç»Ÿè®¡æœåŠ¡ï¼š</label>
      <input id="origin" value="https://counter.bornforthis.cn" />
      <label>domainï¼š</label>
      <input id="domain" />
      <button id="btnHit">Hit +1</button>
      <button id="btnStats">Get Stats</button>
      <button id="btnStatsIps">Get Stats (includeIps=1)</button>
    </div>

    <div class="small" style="margin-top:10px;">
      æç¤ºï¼šæœ¬æ–‡ä»¶é»˜è®¤æŠŠ domain å¡«æˆå½“å‰é¡µé¢ <b>location.hostname</b>ã€‚
      å¦‚æœä½ æ˜¯ç›´æ¥æœ¬åœ°æ‰“å¼€ï¼ˆfile://ï¼‰ï¼Œhostname å¯èƒ½ä¸ºç©ºï¼Œæ­¤æ—¶è¯·æ‰‹åŠ¨å¡«ä½ è¦ç»Ÿè®¡çš„åŸŸåï¼ˆå¦‚ <b>ai.bornforthis.cn</b>ï¼‰ã€‚
      è‹¥å¼€å¯äº†ç™½åå•ï¼ˆallowAll=falseï¼‰ï¼Œdomain å¿…é¡»è½åœ¨ allowedRootDomains å…è®¸èŒƒå›´å†…ï¼Œå¦åˆ™ä¼š 403ã€‚
    </div>
  </div>

  <div class="grid2">
    <div class="card">
      <h1>ğŸ“Œ å¿«é€Ÿç»“æœ</h1>
      <div class="row"><span class="k">domainï¼š</span><span class="v" id="vDomain">-</span></div>
      <div class="row"><span class="k">totalï¼š</span><span class="v" id="vTotal">-</span></div>
      <div class="row"><span class="k">lastï¼š</span><span class="v" id="vLast">-</span></div>
      <div class="row"><span class="k">UVï¼ˆåŸºäº ips æ•°é‡ï¼‰ï¼š</span><span class="v" id="vUv">-</span></div>
      <div class="row"><span class="k">çŠ¶æ€ï¼š</span><span id="vStatus" class="small">-</span></div>
    </div>

    <div class="card">
      <h1>ğŸ§¾ åŸå§‹å“åº” JSON</h1>
      <pre id="raw">ç­‰å¾…è¯·æ±‚...</pre>
    </div>
  </div>

  <div class="card">
    <h1>âœ… è‡ªåŠ¨åŒ–æµ‹è¯•ï¼ˆåŠ è½½ counter.js / æ£€æŸ¥ BFTCounterï¼‰</h1>
    <div class="row">
      <button id="btnLoadJs">åŠ¨æ€åŠ è½½ counter.js</button>
      <button id="btnUseApi">è°ƒç”¨ window.BFTCounter.get()</button>
      <button id="btnListen">ç›‘å¬ bftcounter:update</button>
    </div>
    <pre id="log">æ—¥å¿—è¾“å‡º...</pre>
  </div>

  <!-- ä½ ä¹Ÿå¯ä»¥ç›´æ¥åœ¨è¿™é‡Œé™æ€å¼•å…¥ï¼ˆå¯é€‰ï¼‰ -->
  <!-- <script src="https://counter.bornforthis.cn/counter.js"></script> -->
</div>

<script>
  const $ = (id) => document.getElementById(id);

  const originEl = $('origin');
  const domainEl = $('domain');
  const rawEl = $('raw');

  const vDomain = $('vDomain');
  const vTotal = $('vTotal');
  const vLast = $('vLast');
  const vUv = $('vUv');
  const vStatus = $('vStatus');

  const logEl = $('log');

  function log(line, type="") {
    const prefix = type === "ok" ? "âœ… " : type === "err" ? "âŒ " : "â€¢ ";
    logEl.textContent += `\n${prefix}${line}`;
    logEl.scrollTop = logEl.scrollHeight;
  }

  function setStatus(text, ok=true) {
    vStatus.innerHTML = ok ? `<span class="ok">${text}</span>` : `<span class="err">${text}</span>`;
  }

  // é»˜è®¤å¡«å…¥ domainï¼ˆæ³¨æ„ file:// æ—¶ hostname å¯èƒ½ä¸ºç©ºï¼‰
  domainEl.value = location.hostname || "ai.bornforthis.cn";

  async function request(path) {
    const origin = originEl.value.replace(/\/+$/, "");
    const url = origin + path;
    const r = await fetch(url, { cache: "no-store" });
    // /hit è¿”å› 204 æ²¡ body
    if (r.status === 204) return { _status: 204 };
    const json = await r.json().catch(() => ({}));
    json._status = r.status;
    return json;
  }

  function renderStats(data) {
    vDomain.textContent = data.domain ?? "-";
    vTotal.textContent = data.total ?? "-";
    vLast.textContent = data.last ? new Date(data.last).toLocaleString() : (data.last ?? "-");
    const uv = data.ips ? Object.keys(data.ips).length : "-";
    vUv.textContent = uv;
  }

  // Hit +1ï¼ˆç”¨ GET æˆ– POST éƒ½è¡Œï¼›è¿™é‡Œç”¨ POST æ›´è´´è¿‘ sendBeaconï¼‰
  $('btnHit').onclick = async () => {
    const d = encodeURIComponent(domainEl.value.trim());
    try {
      const origin = originEl.value.replace(/\/+$/, "");
      const url = `${origin}/hit?d=${d}`;
      const r = await fetch(url, { method: "POST", cache: "no-store" });
      if (r.status === 204) {
        setStatus("Hit æˆåŠŸï¼ˆ204ï¼‰", true);
        rawEl.textContent = `HTTP ${r.status} (No Content)\nå·²å†™å…¥è®¡æ•°ï¼Œæ¥ä¸‹æ¥ç‚¹ Get Stats æŸ¥çœ‹ç»“æœã€‚`;
      } else {
        const t = await r.text();
        setStatus(`Hit å¼‚å¸¸ï¼ˆ${r.status}ï¼‰`, false);
        rawEl.textContent = t;
      }
    } catch (e) {
      setStatus("Hit è¯·æ±‚å¤±è´¥ï¼ˆç½‘ç»œ/CORS/åŸŸåï¼‰", false);
      rawEl.textContent = String(e);
    }
  };

  // Get Stats
  $('btnStats').onclick = async () => {
    const d = encodeURIComponent(domainEl.value.trim());
    try {
      const data = await request(`/stats?d=${d}`);
      rawEl.textContent = JSON.stringify(data, null, 2);
      if (data.ok) {
        setStatus(`Stats OKï¼ˆHTTP ${data._status}ï¼‰`, true);
        renderStats(data);
      } else {
        setStatus(`Stats å¤±è´¥ï¼ˆHTTP ${data._status}ï¼‰: ${data.error || "unknown"}`, false);
      }
    } catch (e) {
      setStatus("Stats è¯·æ±‚å¤±è´¥ï¼ˆç½‘ç»œ/CORS/åŸŸåï¼‰", false);
      rawEl.textContent = String(e);
    }
  };

  // Get Stats includeIps=1
  $('btnStatsIps').onclick = async () => {
    const d = encodeURIComponent(domainEl.value.trim());
    try {
      const data = await request(`/stats?d=${d}&includeIps=1`);
      rawEl.textContent = JSON.stringify(data, null, 2);
      if (data.ok) {
        setStatus(`Stats(includeIps) OKï¼ˆHTTP ${data._status}ï¼‰`, true);
        renderStats(data);
      } else {
        setStatus(`Stats(includeIps) å¤±è´¥ï¼ˆHTTP ${data._status}ï¼‰: ${data.error || "unknown"}`, false);
      }
    } catch (e) {
      setStatus("Stats(includeIps) è¯·æ±‚å¤±è´¥", false);
      rawEl.textContent = String(e);
    }
  };

  // åŠ¨æ€åŠ è½½ counter.js
  $('btnLoadJs').onclick = () => {
    const origin = originEl.value.replace(/\/+$/, "");
    const s = document.createElement('script');
    s.src = origin + "/counter.js";
    s.onload = () => log("counter.js åŠ è½½æˆåŠŸ", "ok");
    s.onerror = () => log("counter.js åŠ è½½å¤±è´¥ï¼ˆæ£€æŸ¥ Nginx/è·¯å¾„/SSLï¼‰", "err");
    document.head.appendChild(s);
    log("å¼€å§‹åŠ è½½ counter.js ...");
  };

  // è°ƒç”¨ window.BFTCounter.get()
  $('btnUseApi').onclick = async () => {
    if (!window.BFTCounter) {
      log("window.BFTCounter ä¸å­˜åœ¨ï¼šè¯·å…ˆåŠ è½½ counter.js", "err");
      return;
    }
    // å¼ºåˆ¶è®© counter.js ä½¿ç”¨ä½ è¾“å…¥çš„ domainï¼ˆå¯é€‰ï¼‰
    // å¦‚æœä½ å¸Œæœ› counter.js è‡ªå·±ç”¨ location.hostnameï¼Œå°±ä¸è¦ç®¡è¿™é‡Œ
    try {
      const data = await window.BFTCounter.get();
      log(`BFTCounter.get() => total=${data.total}`, "ok");
      rawEl.textContent = JSON.stringify(data, null, 2);
      renderStats(data);
    } catch (e) {
      log("BFTCounter.get() è°ƒç”¨å¤±è´¥ï¼š" + String(e), "err");
    }
  };

  // ç›‘å¬ bftcounter:update
  let listening = false;
  $('btnListen').onclick = () => {
    if (listening) { log("å·²åœ¨ç›‘å¬ä¸­"); return; }
    listening = true;
    window.addEventListener("bftcounter:update", (e) => {
      log("æ”¶åˆ°äº‹ä»¶ bftcounter:update => " + JSON.stringify(e.detail), "ok");
    });
    log("å·²å¼€å§‹ç›‘å¬ bftcounter:update", "ok");
  };
</script>
</body>
</html>
